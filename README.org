
* 概要
  Web Server - Rest Server - MySQL の3階層システムのサンプルアプリになります。このバージョンは画像アップロード機能があり、画像はSwiftへアップロードされます。
  [[file:server-setup/SampleApp.png]]

* 動作要件
  - CentOS 6.4以上 (64bit)
  - Python 2.6以上
  - MySQL
  - Swift

* All in One でとりあえず動かす
  nova boot 時(horizonからも可能)に以下をuserdataへ設定すると、All in One 環境が設定できますが、設定ファイルの編集が必要になります。

: #!/bin/bash
: yum install -q -y git
: cd /root
: git clone -q https://github.com/josug-book1-materials/sample-app.git
: cd sample-app
: git checkout -b v2.0 remotes/origin/v2.0
: sh /root/sample-app/server-setup/install_web.sh
: sh /root/sample-app/server-setup/install_rest.sh
: sh /root/sample-app/server-setup/install_db.sh

  設定ファイルを編集してください。編集内容は後述。

: vim /root/sample-app/endpoint.conf


  サービスを起動する。

: sh /root/sample-app/server-setup/web.init.sh start
: sh /root/sample-app/server-setup/rest.init.sh start

  後は Floating IPを割り当てて、ブラウザからアクセスしてください。

  アプリを停止する場合は、

: sh /root/sample-app/server-setup/web.init.sh stop
: sh /root/sample-app/server-setup/rest.init.sh stop

  再起動は以下で行えます。

: sh /root/sample-app/server-setup/web.init.sh restart
: sh /root/sample-app/server-setup/rest.init.sh restart


* 設定（詳細）

  - OpenStack上で3つのインスタンスを起動して設定します。
    + web server
    + rest server
    + db server

  - nova boot 時に以下の userdata を与えます。

: #!/bin/bash
: yum install -q -y git
: cd /root
: git clone https://github.com/josug-book1-materials/sample-app.git
: cd sample-app
: git checkout -b v2.0 remotes/origin/v2.0


** サーバ設定
   各サーバで以下のスクリプトを実行します。

   - web server
: sh /root/sample-app/server-setup/install_web.sh

   - rest server
: sh /root/sample-app/server-setup/install_rest.sh

   - db server
: sh /root/sample-app/server-setup/install_db.sh


** アプリ設定
   endpoint.conf にDBサーバのIPアドレスと、ReSTサーバのIPアドレス、Swiftへアクセスするための情報を記載します。
: /root/sample-app/endpoint.conf

: [rest-server]
: rest_host = 127.0.0.1 ← 実際のアドレスへ書き換え
: rest_endpoint = http://%(rest_host)s:5555/bbs
: 
: [db-server]
: db_host = localhost ← 実際のアドレスへ書き換え
: db_endpoint = mysql://user:password@%(db_host)s/sample_bbs?charset=utf8
: 
: [swift]
: container_name = sample_bbs
: upload_path = /tmp/flask/
: 
: keystone_url = https://region-a.geo-1.identity.hpcloudsvc.com:35357/v2.0/ ← エンドポイント名
: region_name = region-b.geo-1 ← リージョン名
: tenant_name = tenant_name ← テナント名
: user_name = user_name ← ユーザ名
: password = password ← パスワード


* 起動

** Webサーバ
: sh /root/sample-app/server-setup/web.init.sh {start|stop|restart}

** ReSTサーバ
: sh /root/sample-app/server-setup/rest.init.sh {start|stop|restart}

** DBサーバ
   設定スクリプトの中で起動されるため、特に起動は必要ありません。


* 動作確認
  ブラウザでWebサーバのアドレスへアクセスしてください。
